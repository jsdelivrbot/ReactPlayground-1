"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _defineProperty2=require("babel-runtime/helpers/defineProperty"),_defineProperty3=_interopRequireDefault(_defineProperty2),_extends3=require("babel-runtime/helpers/extends"),_extends4=_interopRequireDefault(_extends3),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),_react=require("react"),_react2=_interopRequireDefault(_react),_propTypes=require("prop-types"),_globals=require("./globals"),_Step=require("./Step"),_Step2=_interopRequireDefault(_Step),_throttle=require("./throttle"),_throttle2=_interopRequireDefault(_throttle),inOut=(0,_propTypes.shape)({make:_propTypes.func,duration:_propTypes.number.isRequired,delay:_propTypes.number.isRequired,forever:_propTypes.bool,count:_propTypes.number.isRequired,style:_propTypes.object.isRequired,reverse:_propTypes.bool}),propTypes={when:_propTypes.any,spy:_propTypes.any,collapse:(0,_propTypes.oneOfType)([_propTypes.bool,(0,_propTypes.shape)({height:_propTypes.string})]),cascade:_propTypes.bool,wait:_propTypes.number,step:(0,_propTypes.oneOfType)([(0,_propTypes.instanceOf)(_Step2.default),_propTypes.string]),force:_propTypes.bool,disabled:_propTypes.bool,fraction:_propTypes.number,onReveal:_propTypes.func,children:_propTypes.element.isRequired,refProp:_propTypes.string,innerRef:_propTypes.func,in:inOut.isRequired,out:(0,_propTypes.oneOfType)([inOut,(0,_propTypes.oneOf)([!1])]).isRequired},defaultProps={fraction:.2,when:!0,refProp:"ref"},contextTypes={stepper:_propTypes.object},RevealBase=function(e){function t(e){(0,_classCallCheck3.default)(this,t);var i=(0,_possibleConstructorReturn3.default)(this,(t.__proto__||(0,_getPrototypeOf2.default)(t)).call(this,e));return i.state={style:(0,_extends4.default)({},e.collapse?t.getInitialCollapseStyle(e):void 0,{opacity:!e.when&&e.out?0:void 0})},i.savedChild=!1,i.isListener=!1,i.isShown=!1,i.revealHandler=(0,_throttle2.default)(i.reveal.bind(i,!1),66),i.resizeHandler=(0,_throttle2.default)(i.resize.bind(i),500),i.saveRef=i.saveRef.bind(i),i}return(0,_inherits3.default)(t,e),(0,_createClass3.default)(t,[{key:"saveRef",value:function(e){this.el=e,this.childRef&&this.childRef(e),this.props.innerRef&&this.props.innerRef(e)}},{key:"inViewport",value:function(){if(!this.el||window.document.hidden)return!1;var e=this.el.offsetHeight,i=window.pageYOffset-t.getTop(this.el),s=Math.min(e,window.innerHeight)*(_globals.globalHide?this.props.fraction:0);return i>s-window.innerHeight&&i<e-s}},{key:"hide",value:function(){this.props.out&&this.setState({style:{opacity:0}})}},{key:"resize",value:function(){this&&this.el&&this.props.when&&this.inViewport()&&(this.unlisten(),this.isShown=!!this.props.when,this.setState({style:{opacity:this.props.when||!this.props.out?1:0}}),this.onReveal(this.props))}},{key:"invisible",value:function(){this&&this.el&&(this.savedChild=!1,this.isShown||(this.setState({style:(0,_extends4.default)({},this.state.style,{visibility:"hidden"})}),this.props.collapse&&window.document.dispatchEvent(_globals.collapseend)))}},{key:"animationEnd",value:function(e,t,i){var s=this,n=i.forever,o=i.count,r=i.delay,a=i.duration;if(!n){var l=function(){s&&s.el&&(s.animationEndTimeout=void 0,e.call(s))};this.animationEndTimeout=window.setTimeout(l,r+(a+(t?a:0)*o))}}},{key:"collapse",value:function(e,t,i){if(t.collapse&&t.out){var s=i.duration+(t.cascade?i.duration:0),n=s>>2,o=n>>1,r=n,a=i.delay+(t.when?0:s-n-o),l=s-n+(t.when?o:-o)+"ms",p=i.delay+(t.when?n-o:0)+"ms",h=t.when?!0!==t.collapse&&"height"in t.collapse?t.collapse.height:this.dummyEl&&this.dummyEl.offsetHeight||!1:0;if(!1!==h)return(0,_extends4.default)({},e,{height:h,animationDuration:l,animationDelay:p,boxSizing:"border-box",transition:"height "+r+"ms ease "+a+"ms"})}return e}},{key:"animate",value:function(e){if(this&&this.el&&(this.unlisten(),this.isShown!==!!e.when)){this.isShown=!!e.when;var t=!e.when&&e.out,i=e[t?"out":"in"],s="style"in i&&i.style.animationName||void 0;(e.out||e.when)&&i.make&&(s=i.make()),this.setState({style:this.collapse((0,_extends4.default)({},i.style,{animationDuration:i.duration+"ms",animationDelay:i.delay+"ms",animationIterationCount:i.forever?"infinite":i.count,opacity:1,animationName:s}),e,i),className:i.className}),t?(this.savedChild=_react2.default.cloneElement(this.getChild()),this.animationEnd(this.invisible,e.cascade,i)):this.savedChild=!1,this.onReveal(e)}}},{key:"onReveal",value:function(e){e.onReveal&&e.when&&(this.onRevealTimeout&&(this.onRevealTimeout=window.clearTimeout(this.onRevealTimeout)),e.wait?this.onRevealTimeout=window.setTimeout(e.onReveal,e.wait):e.onReveal())}},{key:"unlisten",value:function(){this.isListener&&(window.removeEventListener("scroll",this.revealHandler),window.removeEventListener("orientationchange",this.revealHandler),window.document.removeEventListener("visibilitychange",this.revealHandler),window.document.removeEventListener("collapseend",this.revealHandler),window.removeEventListener("resize",this.resizeHandler),this.isListener=!1),this.onRevealTimeout&&(this.onRevealTimeout=window.clearTimeout(this.onRevealTimeout)),this.animationEndTimeout&&(this.animationEndTimeout=window.clearTimeout(this.animationEndTimeout))}},{key:"componentWillUnmount",value:function(){this.unlisten(),_globals.ssr&&(0,_globals.disableSsr)()}},{key:"listen",value:function(){this.isListener||(this.isListener=!0,window.addEventListener("scroll",this.revealHandler),window.addEventListener("orientationchange",this.revealHandler),window.document.addEventListener("visibilitychange",this.revealHandler),window.document.addEventListener("collapseend",this.revealHandler),window.addEventListener("resize",this.resizeHandler))}},{key:"reveal",value:function(e){var t=this;if(this&&this.el)if(e||(e=this.props),e.when&&this.isShown&&"spy"in e)this.isShown=!1,this.setState({style:{}}),window.setTimeout(function(){return t.reveal(e)},200);else if(this.inViewport()){if(this.start)return this.hide(),this.listen(),void this.start(this.step);this.animate(e)}else this.listen()}},{key:"componentDidMount",value:function(){if(this.el&&!this.props.disabled){if(this.props.force)return this.animate(this.props);this.props.step&&(this.props.step instanceof _Step2.default?this.props.step.push(this):this.context.stepper&&this.context.stepper.get(this.props.step).push(this)),_globals.ssr&&(this.props.out||this.props.effect)&&t.getTop(this.el)<window.pageYOffset+window.innerHeight?(this.setState({style:{opacity:0,transition:"opacity 1000ms"}}),window.setTimeout(this.revealHandler,1e3)):this.props.when&&this.reveal(this.props)}}},{key:"cascade",value:function(e){var t=this,i=void 0;i="string"==typeof e?e.split("").map(function(e,t){return _react2.default.createElement("span",{key:t,style:{display:"inline-block",whiteSpace:"pre"}},e)}):_react2.default.Children.toArray(e);var s=this.props[this.props.when||!this.props.out?"in":"out"].duration,n=i.length,o=2*s;this.props.collapse&&(o=parseInt(this.state.style.animationDuration,10),s=o/2);var r=0;return i=i.map(function(e){return _react2.default.cloneElement(e,{style:(0,_extends4.default)({},e.props.style,t.state.style,{animationDuration:Math.round((0,_globals.cascade)(r++,0,n,s,o))+"ms"})})})}},{key:"componentWillReceiveProps",value:function(e){if(!e.disabled){if(e.collapse&&!this.props.collapse)return this.setState({style:t.getInitialCollapseStyle(e)}),void(this.isShown=!1);e.when&&!0===e.collapse&&this.dummyEl&&this.dummyEl.offsetHeight&&this.state.style.height!==this.dummyEl.offsetHeight&&this.setState({style:(0,_extends4.default)({},this.state.style,{height:this.dummyEl.offsetHeight})}),e.when===this.props.when&&e.spy===this.props.spy||this.reveal(e),this.onRevealTimeout&&!e.when&&(this.onRevealTimeout=window.clearTimeout(this.onRevealTimeout))}}},{key:"dummy",value:function(e,t){var i,s=this;return!0!==this.props.collapse&&"height"in this.props.collapse?e:_react2.default.createElement("span",null,[e,_react2.default.createElement(e.type,(0,_extends4.default)({},e.props,(i={children:t.props.children,key:2},(0,_defineProperty3.default)(i,this.props.refProp,function(e){return s.dummyEl=e}),(0,_defineProperty3.default)(i,"style",(0,_extends4.default)({},e.props.style,{position:"absolute",left:"-9999em",top:"-9999em",height:"auto",animationName:"none",animationDuration:"0s",transition:"none",opacity:0})),i)))])}},{key:"getChild",value:function(){return this.savedChild&&!this.props.disabled?this.savedChild:1===_react2.default.Children.count(this.props.children)?_react2.default.Children.only(this.props.children):(console.warn("react-reveal expects a single child"),_react2.default.createElement("div"))}},{key:"render",value:function(){var e=this.getChild();"function"==typeof e.ref&&(this.childRef=e.ref);var t=!1,i=e.props,s=i.style,n=i.className,o=i.children,r=this.props.disabled?n:(this.props.out?_globals.namespace:"")+(this.state.className?" "+this.state.className:"")+(n?" "+n:"")||void 0,a=this.props.disabled?s:(0,_extends4.default)({},s,this.state.style);this.props.cascade&&!this.props.disabled&&o&&this.state.style.animationName&&(t=this.cascade(o),a.animationName=void 0);var l=(0,_extends4.default)({},this.props.props,(0,_defineProperty3.default)({className:r,style:a},this.props.refProp,this.saveRef));this.props.collapse&&!this.props.disabled&&(l.key=1);var p=_react2.default.cloneElement(e,l,t||o);return this.props.collapse&&!this.props.disabled?this.dummy(p,e):p}}],[{key:"getTop",value:function(e){for(;void 0===e.offsetTop;)e=e.parentNode;for(var t=e.offsetTop;e.offsetParent;t+=e.offsetTop)e=e.offsetParent;return t}},{key:"getInitialCollapseStyle",value:function(e){return{visibility:e.when||!e.out?"visible":"hidden",height:0,boxSizing:"border-box"}}}]),t}(_react2.default.Component);RevealBase.propTypes=propTypes,RevealBase.defaultProps=defaultProps,RevealBase.contextTypes=contextTypes,exports.default=RevealBase,module.exports=exports.default;